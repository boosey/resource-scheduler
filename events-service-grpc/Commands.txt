
# Build for OCP and deploy 
./mvnw clean package -Dquarkus.container-image.build=true -Dquarkus.kubernetes.deploy=true -Dquarkus.openshift.expose=true

# Deploy Mongo event store
kubectl create -n resource-scheduler -f src/main/k8s/MongoEventStore.yaml

# Create deployment config
kubectl create -n resource-scheduler -f src/main/k8s/EventServiceGrpc.yaml

# Delete all Triggers
kn trigger list | grep -Eo '^[^ ]+' | grep -v 'NAME' | xargs -n1  kn trigger delete 

# Delete all completed pods
oc get pods | grep Completed | grep -Eo '^[^ ]+' | xargs -n1 oc delete pod

# Label namespace
oc label namespace resource-scheduler eventing.knative.dev/injection=enabled

# Build locally and deploy
mvn clean install \
&& docker build -f src/main/docker/Dockerfile.jvm -t docker.io/boosey/eventsservicegrpc . \
&& docker push docker.io/boosey/eventsservicegrpc \
&& oc rollout latest deploymentconfig/eventsservicegrpc  


curl -v "http://broker-ingress.knative-eventing.svc.cluster.local/resource-scheduler/default/" \
-H "Ce-Id: 1234" \
-H "Ce-Specversion: 1.0" \
-H "Ce-Type: ADD_RESOURCE" \
-H "Ce-Source: RESOURCE_API" \
-H "Content-Type: text/plain" \
-d '"{\"id\":\"c8c9f318-36db-4f73-9d3a-b3db45b8aed5\",\"name\":\"Space 416\",\"ownerId\":\"e0696ad4-538e-4e10-b1db-b1fedbc69e51\",\"active\":true,\"availableByDefault\":true}"'
