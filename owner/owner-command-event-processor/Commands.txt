
# Install Servless Operator
# Create Knative Serving in knative-serving namespace
# Create Knative Eventing in knative-eventing namespace

# Create broker in owner-scheduler namespace
kubectl label namespace owner-scheduler knative-eventing-injection=enabled

# Check for Broker and Pods
watch kubectl --namespace knativetutorial get broker
watch kubectl get pods

# Build Project, Docker Image, and Push to Docker Hub
# then create the knative service
mvn clean install \
&& docker build -f src/main/docker/Dockerfile.jvm -t docker.io/boosey/owner-command-event-processor . \
&& docker push docker.io/boosey/owner-command-event-processor \
&& kubectl apply -n owner-scheduler -f /Users/boosey/Projects/owner-scheduler/owner-command-event-processor/src/main/k8s/ResourceCommandEventProcessor.yaml

# Create Trigger
kubectl apply -n owner-scheduler -f /Users/boosey/Projects/owner-scheduler/owner-commands/src/main/k8s/AddResourceTrigger.yaml
# Verify triggers
kubectl --namespace owner-scheduler  get triggers.eventing.knative.dev
kubectl get trigger addowner -o jsonpath='{.status.subscriberUri}'

# Run
# Tail logs
stern funq user-container
# Get Broker URL
kubectl get broker default -o jsonpath='{.status.address.url}'
# Start curler pod
kubectl -n owner-scheduler exec -it curler -- /bin/bash

# Test
curl -v "http://default-broker.owner-scheduler.svc.cluster.local" \
-X POST \
-H "Ce-Id: 1234" \
-H "Ce-Specversion: 1.0" \
-H "Ce-Type: addResource" \
-H "Ce-Source: curl" \
-H "Content-Type: application/json" \
-d '{"name" : "Space 204", "available" : "true"}'


# Update Service
# IMPORTANT: ResourceCommandService.yaml -> update spec:template:metadata:namespace
mvn clean install \
&& docker build -f src/main/docker/Dockerfile.jvm -t docker.io/boosey/owner-command-event-processor . \
&& docker push docker.io/boosey/owner-command-event-processor \
&& kubectl apply -n owner-scheduler -f /Users/boosey/Projects/owner-scheduler/owner-command-event-processor/src/main/k8s/ResourceCommandEventProcessor.yaml


# Create mongodb from mongo supplied operator
# Create API Key secret
kubectl -n owner-scheduler \
  create secret generic owner-scheduler-mongo-cloud-manager-api-key \
  --from-literal="user=56fa4b37-f68b-4662-8004-b6db9371dff7" \
  --from-literal="publicApiKey=56fa4b37-f68b-4662-8004-b6db9371dff7"

# Create Config Map
kubectl create configmap mongo-cloud-manager-config \
  --from-literal="baseUrl=https://cloud.mongodb.com/v2#/org/5f71414cb909195063a1f252" \
  --from-literal="projectName=owner-scheduler" \
  --from-literal="orgId=owner-scheduler"